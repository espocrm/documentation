# Управление Бизнес-Процессами

Инструмент управления бизнес-процессами (BPM) предоставляет возможность моделировать и автоматизировать бизнес-процессы в EspoCRM. Это определнного рода двигатель, выполняющий бизнес-процессы, описанные в стандарте BPMN 2.0. Инструмент BPM доступен в расширении [Advanced Pack](https://www.espocrm.com/extensions/advanced-pack/).

![BPM example](https://raw.githubusercontent.com/espocrm/documentation/master/_static/images/administration/bpm/bpm-1.png)

### Основное отличие от инструмента Workflows

Инструмент Workflows предназначен для автоматизации простых бизнес-правил, без последовательных элементов потока, когда нет необходимости отображать поток графически.

Инструмент BPM предназначен для более сложных бизнес-потоков, где могут быть расходящиеся и сходящиеся потоки, задержки выполнения, взаимодействие пользователей. Представление блок-схемы делает бизнес-процесс более понятным для человека, а журнал позволяет увидеть, как был проведен этот процесс.

## Технологические блок-схемы

Связь с технологическими блок-схемами доступна на панели администрирования. Она также может быть добавлена в виде вкладка на панели навигации.

Блок-схемы предназначены для моделирования бизнес-процессов. Администратор может создавать и редактировать блок-схемы. Обычные пользователи могут просматривать только блок-схемы.

Каждая блок-схема имеет свой тип конкретного объекта (поле Target Type). Блок-схема определяет выполнение будущих экземпляров процесса. Он содержит элементы блок-схемы и соединения между элементами.

Если в блок-схеме процесса имеется непроверенное поле «активно», оно не будет инициировать экземпляры процессов.

Чтобы показать детали и параметры определенного элемента блок-схемы, вам нужно щелкнуть по нему. В режиме редактирования вы сможете редактировать параметры.

## Процессы

Процессы доступны в панели администрирования. Ссылка также может быть добавлена в виде вкладки на панели навигации.

Процесс представляет собой экземпляр бизнес-процесса. Когда он инициируется, он получает статус «Запущен». Когда процесс завершен, он получает статус «Завершен». Этот процесс также может быть остановлен вручную пользователем, у которого есть доступ к редактированию процесса. Если он остановлен вручную, он получает статус «Остановлен».

Процесс выполняется в соответствии с блок-схемой. Блок-схема процесса не может быть изменена после запуска процесса.

Процесс обязательно связан с одной целевой записью.

Процессы могут запускаться автоматически (при определенных условиях или по расписанию) или вручную (где в блок-схеме есть хотя бы одно стартовое событие). Чтобы запустить процесс вручную, пользователю необходимо нажать кнопку «Начать процесс» в самом списке процессов.

## Элементы блок-схемы

### Мероприятия

События отображаются на блок-схеме в виде кругов.

#### Запуск события

Не имеет параметров. Это отправная точка процесса. Начало события может быть инициировано вручную пользователем, у которого есть доступ к созданию процессов. Пользователь должен нажать кнопку «Начать процесс» в представлении списка процессов.

#### Условное начало события

Отправная точка процесса. Она должна срабатывать автоматически при соблюдении определенных условий. Существует два типа триггера: «После создания записи», «После сохранения записи».

#### Событие запуска таймера

Отправная точка процесса. Она инициирует процессы путем планирования. Вам нужно указать отчет из списка, который возвращает записи для инициирования процессов и планирования в нотации crontab.

#### Промежуточное условное событие

Это событие останавливает поток до тех пор, пока не будут выполнены указанные критерии.

#### Промежуточное событие таймера

Это событие останавливает поток и ждет, пока оно определено параметрами события.

Для более сложных настроек таймера вы можете использовать [formula](formula.md). Сценарии формул должны возвращать значение Date-Time (в часовой пояс UTC). По истечении этого времени поток будет переходить к следующему элементу.

Используя функцию datetime\closeest formula, можно установить таймер в определенное время в будущем, например: начало следующего рабочего дня.

#### Конец события

Завершает текущий поток. Это не приводит к параллельной работе потоков. Когда поток достигнет конечного события, и ничто не работает параллельно, тогда процесс заканчивается.

#### Завершение события

Завершает все потоки. Процесс заканчивается.

### Шлюзы

Шлюзы отображаются в виде бриллиантов.

#### Эксклюзивный шлюз

Может разводить или сводить потоки.

В случае расхождения определяется один поток (путь), который будет выбран в соответствии с указанными критериями. Первое условие выполнения определяет поток, а следующие условия опущены. Существует возможность указать поток по умолчанию. Поток выбирается по умолчанию, если нет каких-либо условий. Поток по умолчанию отмечен косой чертой.

В случае слияния он просто направляет поток в исходящий элемент. Он не блокируется после потока, но параллельные потоки не будут объединены в один поток.

![exclusive gateway divergent](https://raw.githubusercontent.com/espocrm/documentation/master/_static/images/administration/bpm/gateway-exclusive-divergent.png)

![exclusive gateway convergent](https://raw.githubusercontent.com/espocrm/documentation/master/_static/images/administration/bpm/gateway-exclusive-convergent.png)

#### Включающий шлюз

Может разводить или сводить потоки.

В случае расхождения он может направлять один или несколько параллельных потоков (путей) в зависимости от выполнения критериев каждого потока. Поток выбирается по умолчанию, если нет каких-либо условий. Поток по умолчанию отмечен косой чертой.

Если возникает необходимость объединить параллельные потоки, создаваемые расходящимся включенным шлюзом, вам необходимо использовать конвергентный включенный шлюз. Он будет ожидать все входящие потоки, а затем продолжит исходящий элемент.

![inclusive gateway](../_ static/ images/administration/bpm/gateway-inclusive.png)

Примечание. Расходящиеся и сходящиеся шлюзы должны быть сбалансированы.

Примечание. Если по какой-то причине один из параллельных потоков был закончен, то расходящийся шлюз никогда не будет обработан. Процесс будет заблокирован. Избегайте создания блок-схемы, которая может привести к такой ситуации.

#### Параллельный шлюз

Может разводить или сводить потоки.

В случае расхождения он разбивает поток на несколько параллельных потоков. Для этого типа шлюза нет параметров.

В случае слияния он ожидает, пока все входящие потоки придут, а затем перейдут к следующему исходящему элементу.

![parallel gateway](https://raw.githubusercontent.com/espocrm/documentation/master/_static/images/administration/bpm/gateway-parallel.png)

Примечание. Расходящиеся и сходящиеся шлюзы должны быть сбалансированы.

Примечание. Если по какой-то причине один из параллельных потоков был закончен, то расходящийся шлюз никогда не будет обработан. Процесс будет заблокирован. Избегайте создания блок-схемы, которая может привести к такой ситуации.

#### Шлюз на основе события

Может только разводить потоки.

Он останавливает поток до тех пор, пока не произойдет срабатывание какого-либо из исходящих событий. Триггерное событие определяет единственный поток. Другие исходящие события отклоняются.

На другом конце потоков исходящей последовательности могут быть только промежуточные события.

![event based gateway](https://raw.githubusercontent.com/espocrm/documentation/master/_static/images/administration/bpm/gateway-event-based.png)

### Действия

Действия отображаются как закругленные прямоугольники.

#### Задача

Задача может выполняться после действий:

* Создать запись - создает новую запись любого типа сущности;
* Создать соответствующую запись - создает новую запись, связанную с целевой записью;
* Обновить целевую запись;
* Обновить соответствующую запись - обновляет запись или записи, связанные с целевой записью;
* Обновить созданную запись - обновляет определенное поле любой записи, созданной в текущем процессе;
* Обновить запись процесса - может использоваться для назначения процесса конкретному пользователю или команде;
* Ссылка на другую запись - связывает целевую запись с указанной записью;
* Отменить связь с другой записью - отменить целевую запись из указанной записи;
* Применить правило назначения - назначает целевую запись, запись процесса или любую запись, созданную процессом в соответствии с конкретным правилом;
* Создать уведомление - создает уведомление в приложении для определенных пользователей;
* Функция Make Followed - позволяет конкретным пользователям следовать за целевой записью, записью процесса или любой записью, созданной процессом;
* Выполнить определенное действие службы - запускает пользовательские действия службы, реализованные разработчиками.

Действия, доступные для задачи, почти такие же, как в функции Workflow. Подробнее о [функции Workflows](workflows.md#actions).

#### Задача отправки сообщений

Отправляет электронное сообщение конкретному получателю.

#### Пользовательская задача

Обеспечивает гибкую способность взаимодействия с пользователем. Он прекращает выполнение до тех пор, пока пользователь (заданный явно или по назначению) не разрешит задачу. В системе будет создана запись пользовательской задачи процесса. По умолчанию существует три типа действий: Утверждение, Обзор, Выполнение.

* Тип утверждения требует, чтобы пользователь выбирал между «Approved» и «Declined».
* Тип отзыва дает только один вариант: «Отзыв».
* Тип выполнения имеет два варианта: «Завершено» и «Сбой».


Пользователь, назначенный для созданной записи пользовательской задачи процесса, получит уведомление в приложении. Администратор также может включать уведомления по электронной почте.

Пользователи также могут добавить определенную задачу на свою панель инструментов, чтобы увидеть их фактические задачи.

Можно увидеть разрешение пройденной задачи пользователя в расходящихся шлюзах или условных событиях, что делает разветвление в потоке процесса.

#### Задача скрипта

Выполняет скрипт на языке [espo-formula](formula.md). Все заданные переменные (`$variableName`) будут сохранены и доступны в процессе.

### Потоки

#### Поток последовательности

Представляет собой сплошную стрелу. Указывает порядок, в котором будут выполняться элементы процесса.

## Условия

Условные события, эксклюзивные и включающие расходящиеся шлюзы имеют условия, которые определяют поток процесса.

Через интерфейс пользователя можно проверить условия для следующих записей:

* Целевая запись;
* Записи, относящиеся к цели через отношения «один-на-один» и «от ребенка к родителям»;
* Записи, созданные процессом через задачи;
* Записи пользовательских задач, которые позволяют проверять разрешение.

Также можно определить условия на языке [Espo-formula](formula.md).

Условия в инструменте BPM те же, что и в функции Workflow. Подробнее об этом [функция Workflows](условия workflows.md #).

## Примеры

### Пример 1

![Example 1](https://raw.githubusercontent.com/espocrm/documentation/master/_static/images/administration/bpm/example-1.png)

### Пример 2

![Example 2](https://raw.githubusercontent.com/espocrm/documentation/master/_static/images/administration/bpm/example-2.png)

### Пример 3

![Example 3](https://raw.githubusercontent.com/espocrm/documentation/master/_static/images/administration/bpm/example-3.png)
